<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Busan Absolute Fixed Portal</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
    body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
    #menu-overlay {
        position:absolute;top:0;left:0;width:100%;height:100%;
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        background:rgba(0,0,0,0.9);color:white;z-index:20;text-align:center;
    }
    .menu-btn {
        width: 220px; padding:15px; margin:10px; font-size:18px;
        background:transparent; border:2px solid #00ffff; border-radius:5px;
        color:#00ffff; cursor:pointer; text-shadow: 0 0 8px #00ffff;
    }
    #btn-reset {
        position:absolute;top:20px;right:20px;padding:10px 20px;
        background:rgba(0,0,0,0.5);border:1px solid #00ffff;
        color:#00ffff;border-radius:5px;z-index:25;display:none;
    }
    #status-ui {
        position:absolute; bottom:15%; width:100%; text-align:center;
        color:#ff00ff; font-weight:bold; z-index:10; pointer-events:none;
        text-shadow: 0 0 10px #ff00ff; font-size: 1.2rem;
    }
</style>
</head>
<body>

<div id="menu-overlay">
    <h1 style="color:#00ffff; letter-spacing: 5px;">BUSAN NEON</h1>
    <button class="menu-btn" onclick="startPortal('day')">MORNING</button>
    <button class="menu-btn" onclick="startPortal('noon')">NOON</button>
    <button class="menu-btn" onclick="startPortal('night')">NIGHT</button>
</div>

<div id="status-ui">画面を長押しして5m進んでください</div>
<button id="btn-reset" onclick="resetToMenu()">最初に戻る</button>

<script>
let scene, camera, renderer, currentPortal=null, tunnelGroup, moveZ=0, targetZ=0, isTouch=false, isImmersed=false;
const loader = new THREE.TextureLoader();

const portalData = {
    day:   { color: 0x00ffff, img: './day_1.jpg' },
    noon:  { color: 0xffea00, img: './day_2.jpg' },
    night: { color: 0xbf55ec, img: './night_1.jpg' }
};

function initScene() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 0);

    renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 背景カメラ映像
    navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
    .then(stream => {
        const video = document.createElement('video');
        video.srcObject = stream; video.setAttribute('playsinline',''); video.play();
        scene.background = new THREE.VideoTexture(video);
    });

    createNeonTunnel();

    document.addEventListener('touchstart', e => { if(e.target.tagName !== 'BUTTON') isTouch=true; });
    document.addEventListener('touchend', () => isTouch=false);
    
    window.addEventListener('deviceorientation', e => {
        // デバイスの向き（目線）を更新。カメラ座標とは独立して動作
        camera.rotation.set((e.beta-90)*Math.PI/180, 0, e.alpha*Math.PI/180, 'YXZ');
    });

    animate();
}

function createNeonTunnel() {
    tunnelGroup = new THREE.Group();
    const gridColor = 0xff00ff;
    const createGrid = (y, rX, rY, posX=0) => {
        const g = new THREE.GridHelper(200, 40, gridColor, gridColor);
        g.position.set(posX, y, 0);
        g.rotation.set(rX, 0, rY);
        return g;
    };
    tunnelGroup.add(createGrid(0, 0, 0)); // 床
    tunnelGroup.add(createGrid(4, 0, 0)); // 天井
    tunnelGroup.add(createGrid(2, Math.PI/2, Math.PI/2, -3)); // 左壁
    tunnelGroup.add(createGrid(2, Math.PI/2, Math.PI/2, 3));  // 右壁
    scene.add(tunnelGroup);
}

function startPortal(type) {
    if(!scene) initScene();
    if(currentPortal) scene.remove(currentPortal.group);

    const data = portalData[type];
    const group = new THREE.Group();
    group.position.set(0, 1.5, -5); 

    const tex = loader.load(data.img);
    const sphere = new THREE.Mesh(
        new THREE.SphereGeometry(20, 60, 40).scale(-1, 1, 1),
        new THREE.MeshBasicMaterial({map:tex, transparent:true, opacity:0})
    );
    
    const frame = new THREE.Mesh(
        new THREE.RingGeometry(1.2, 1.4, 4),
        new THREE.MeshBasicMaterial({color: data.color, side: THREE.DoubleSide})
    );
    frame.rotation.z = Math.PI / 4;

    group.add(sphere, frame);
    scene.add(group);

    currentPortal = { group, sphere, frame, z: -5 };
    isImmersed = false;
    moveZ = targetZ = 0;
    tunnelGroup.visible = true; // ネオン再表示

    document.getElementById('menu-overlay').style.display = 'none';
    document.getElementById('btn-reset').style.display = 'block';
    document.getElementById('status-ui').innerText = "5m先の世界へ進んでください";
}

function animate() {
    requestAnimationFrame(animate);

    if(!isImmersed) {
        // 移動フェーズ
        if(isTouch) targetZ += 0.04; // 移動速度
        moveZ += (targetZ - moveZ) * 0.1;
        camera.position.z = -moveZ;

        // 没入判定（5m地点）
        if(-camera.position.z >= 5.0) {
            isImmersed = true;
            tunnelGroup.visible = false;      // ネオン線を消す
            currentPortal.frame.visible = false; // ドア枠を消す
            document.getElementById('status-ui').innerText = "没入中：目線のみ有効";
        }
    } else {
        // 【絶対固定】移動計算を無視し、座標を球体中心に強制ロック
        // これにより物理的なスマホの揺れ（前後左右の移動）を無効化します
        camera.position.set(0, 1.5, -5);
    }

    if(currentPortal) {
        const dist = Math.abs(camera.position.z - currentPortal.z);
        // 画像のフェードイン処理
        const opacity = THREE.MathUtils.clamp((3.5 - dist) / 1.5, 0, 1);
        currentPortal.sphere.material.opacity = opacity;
    }

    renderer.render(scene, camera);
}

function resetToMenu() {
    location.reload(); 
}
</script>
</body>
</html>
