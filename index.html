<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Busan Light Door Warp</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
body { margin:0; overflow:hidden; background:#000; }
#overlay{
 position:fixed; inset:0;
 background:rgba(0,0,0,0.85);
 color:#fff; display:flex;
 justify-content:center; align-items:center;
 cursor:pointer; z-index:1000;
}
#whiteout{
 position:fixed; inset:0;
 background:#fff; opacity:0;
 pointer-events:none; z-index:900;
}
.btn{
 padding:15px 30px;
 border:2px solid #fff;
 border-radius:50px;
 font-size:1.2rem;
}
</style>
</head>
<body>

<div id="overlay" onclick="startApp()">
 <div class="btn">釜山へ</div>
</div>
<div id="whiteout"></div>

<script>

let scene, camera, renderer;
let skyMesh, planeMesh, doorL, doorR, sphere, particles;
let phase = "flight";
let warpStart = 0;

const loader = new THREE.TextureLoader();

function startApp(){
 document.getElementById("overlay").style.display="none";
 init();
}

function init(){

 scene = new THREE.Scene();
 camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 2000);
 camera.position.z = 5;

 renderer = new THREE.WebGLRenderer({antialias:true});
 renderer.setSize(innerWidth, innerHeight);
 document.body.appendChild(renderer.domElement);

 // ===== 空背景 =====
 loader.load("./sora.jpg", tex=>{
  skyMesh = new THREE.Mesh(
   new THREE.SphereGeometry(600,64,32).scale(-1,1,1),
   new THREE.MeshBasicMaterial({map:tex})
  );
  scene.add(skyMesh);
 });

 // ===== 飛行機 =====
 loader.load("./hikouki.png", tex=>{
  tex.transparent = true;
  planeMesh = new THREE.Mesh(
   new THREE.PlaneGeometry(4,2.5),
   new THREE.MeshBasicMaterial({map:tex, transparent:true})
  );
  planeMesh.position.set(0,0,-10);
  scene.add(planeMesh);
 });

 // ===== 光の扉 =====
 const doorGeo = new THREE.PlaneGeometry(4,12);
 const doorMat = new THREE.MeshBasicMaterial({
  color:0xffffff,
  transparent:true,
  opacity:0.9
 });

 doorL = new THREE.Mesh(doorGeo, doorMat.clone());
 doorR = new THREE.Mesh(doorGeo, doorMat.clone());

 doorL.position.set(-2,0,-15);
 doorR.position.set(2,0,-15);

 scene.add(doorL,doorR);

 // 光の縁取り
 const glowMat = new THREE.MeshBasicMaterial({
  color:0x66ccff,
  transparent:true,
  opacity:0.7
 });

 const glowL = new THREE.Mesh(
   new THREE.PlaneGeometry(4.2,12.2),
   glowMat
 );
 glowL.position.copy(doorL.position);
 scene.add(glowL);

 const glowR = new THREE.Mesh(
   new THREE.PlaneGeometry(4.2,12.2),
   glowMat.clone()
 );
 glowR.position.copy(doorR.position);
 scene.add(glowR);

 // ===== 粒子 =====
 const pGeo = new THREE.BufferGeometry();
 const pCount = 500;
 const pos = new Float32Array(pCount*3);
 for(let i=0;i<pCount*3;i++){
  pos[i]=(Math.random()-0.5)*5;
 }
 pGeo.setAttribute("position",new THREE.BufferAttribute(pos,3));

 const pMat = new THREE.PointsMaterial({
  color:0xffffff,
  size:0.1,
  transparent:true,
  opacity:0
 });

 particles = new THREE.Points(pGeo,pMat);
 scene.add(particles);

 // ===== 釜山背景 =====
 loader.load("./day_2.jpg", tex=>{
  sphere = new THREE.Mesh(
   new THREE.SphereGeometry(600,64,32).scale(-1,1,1),
   new THREE.MeshBasicMaterial({
    map:tex,
    transparent:true,
    opacity:0
   })
  );
  scene.add(sphere);
 });

 window.addEventListener("click",()=>{
  if(phase==="flight"){
   phase="warp";
   warpStart=performance.now();
  }
 });

 animate();
}

function animate(){
 requestAnimationFrame(animate);

 const white = document.getElementById("whiteout");
 const now = performance.now();

 if(phase==="warp"){

  const t = now - warpStart;

  // 扉ゆっくり開く
  if(t>500){
   doorL.position.x -= 0.02;
   doorR.position.x += 0.02;
  }

  // 飛行機前進
  if(planeMesh){
   planeMesh.position.z -= 0.2;
  }

  // 粒子出現
  if(particles){
   particles.material.opacity = 1;
   particles.position.z = planeMesh.position.z;
  }

  if(planeMesh.position.z < -25){
   phase="whiteout";
   warpStart=now;
  }
 }

 else if(phase==="whiteout"){

  const t = now - warpStart;
  white.style.opacity = Math.min(1, t/500);

  if(t>600){

   // 空削除
   if(skyMesh) scene.remove(skyMesh);
   if(doorL) scene.remove(doorL);
   if(doorR) scene.remove(doorR);
   if(planeMesh) scene.remove(planeMesh);

   phase="arrival";
   warpStart=now;
  }
 }

 else if(phase==="arrival"){

  const t = now - warpStart;
  white.style.opacity = 1 - t/2000;

  if(sphere){
   sphere.material.opacity = Math.min(1, t/2000);
  }
 }

 renderer.render(scene,camera);
}

</script>
</body>
</html>
