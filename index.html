<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Busan AR Portal - 360 Full Immersive</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
#tap-overlay {position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);color:white;z-index:10;text-align:center;}
#btn-start {padding:15px 40px;font-size:20px;background:#bf55ec;border:none;border-radius:50px;color:white;cursor:pointer;margin-top:20px;}
#btn-reset {position:absolute;top:20px;right:20px;padding:10px 20px;background:rgba(255,255,255,0.2);border:1px solid white;color:white;border-radius:5px;z-index:15;display:none;cursor:pointer;}

/* タイトルエリアのデザイン修正 */
#title-container {
    position:absolute;top:15%;width:100%;text-align:center;
    z-index:8;display:none;pointer-events:none;
}
#main-title {
    font-size:2.8rem;color:#bf55ec;font-weight:bold;
    text-shadow: 0 0 10px #bf55ec, 0 0 20px #bf55ec;
}
#sub-title {
    font-size:1.1rem;color:white;margin-top:5px;
    letter-spacing: 2px;
}
</style>
</head>
<body>
<div id="tap-overlay">
    <h2>プサン 没入体験</h2>
    <p>長押しでゆっくり前進<br>3枚のドアから行き先を選んでください</p>
    <button id="btn-start">開始</button>
</div>

<div id="title-container">
    <div id="main-title">부산에 오신 것을</div>
    <div id="sub-title">プサンへようこそ</div>
</div>

<button id="btn-reset">最初に戻る</button>

<script>
let scene, camera, renderer, portals=[], moveZ=0, targetZ=0, moveX=0, isTouch=false;

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0,1.6,0);

    renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}})
    .then(stream=>{
        const video=document.createElement('video');
        video.srcObject=stream;
        video.setAttribute('playsinline','');
        video.play();
        scene.background = new THREE.VideoTexture(video);
    });

    const loader = new THREE.TextureLoader();
    // ドアの配置：開始時にすぐ見つかるよう、5m先に扇形に配置
    const confs = [
        {x:-2.5, z:-5, img:'./day_1.jpg', color:0x87CEEB}, // 左前
        {x: 0,   z:-5, img:'./day_2.jpg', color:0x8B4513}, // 正面
        {x: 2.5, z:-5, img:'./night_1.jpg', color:0xbf55ec} // 右前
    ];

    confs.forEach(c=>{
        const group = new THREE.Group();
        group.position.set(c.x, 1.5, c.z);

        const dGeo = new THREE.PlaneGeometry(1.2, 3.5);
        const L = new THREE.Mesh(dGeo, new THREE.MeshBasicMaterial({color:c.color}));
        const R = new THREE.Mesh(dGeo, new THREE.MeshBasicMaterial({color:c.color}));
        L.position.set(-0.6, 0, 0.1);
        R.position.set(0.6, 0, 0.1);

        // 【修正】360度没入用の球体（Sphere）
        const tex = loader.load(c.img);
        // パノラマ画像を球体の中に正しく貼るための設定
        const sphereGeo = new THREE.SphereGeometry(15, 60, 40);
        sphereGeo.scale(-1, 1, 1); // 内側に向ける
        const sphereMat = new THREE.MeshBasicMaterial({map:tex, transparent:true, opacity:0});
        const sphere = new THREE.Mesh(sphereGeo, sphereMat);
        sphere.position.set(0, 0, -10); // ドアの少し奥に配置

        group.add(L,R,sphere);
        scene.add(group);
        portals.push({group,L,R,sphere,x:c.x,z:c.z});
    });

    document.addEventListener('touchstart', e=>{ if(e.target.tagName !== 'BUTTON') isTouch=true; });
    document.addEventListener('touchend', ()=>isTouch=false);

    window.addEventListener('deviceorientation', e=>{
        camera.rotation.set((e.beta-90)*Math.PI/180,0,e.alpha*Math.PI/180,'YXZ');
        if(e.gamma) moveX = e.gamma * 0.1; 
    });

    animate();
    document.getElementById('title-container').style.display = 'block';
}

function animate() {
    requestAnimationFrame(animate);

    if(isTouch) targetZ += 0.02; // 低速移動
    moveZ += (targetZ - moveZ) * 0.1;
    
    camera.position.x += (moveX - camera.position.x) * 0.1;
    camera.position.z = -moveZ;

    portals.forEach(p=>{
        const dz = camera.position.z - p.z;
        const dx = camera.position.x - p.x;
        const dist = Math.sqrt(dx*dx + dz*dz);

        if(dist < 10){
            p.group.visible = true;
            const openProgress = THREE.MathUtils.clamp((2.5-dist)/2.5, 0, 1);

            // ドアをスライド
            p.L.position.x = THREE.MathUtils.lerp(p.L.position.x, openProgress > 0 ? -2.5 : -0.6, 0.02);
            p.R.position.x = THREE.MathUtils.lerp(p.R.position.x, openProgress > 0 ? 2.5 : 0.6, 0.02);
            
            // ドアをくぐり始めると、360度球体が出現
            if(openProgress > 0.1) {
                p.sphere.material.opacity = THREE.MathUtils.lerp(p.sphere.material.opacity, 1, 0.05);
            }
        } else {
            p.group.visible = false;
            p.sphere.material.opacity = 0;
        }
    });

    renderer.render(scene,camera);
}

document.getElementById('btn-start').onclick = ()=>{
    init();
    document.getElementById('tap-overlay').style.display='none';
    document.getElementById('btn-reset').style.display='block';
};

document.getElementById('btn-reset').onclick = ()=>{
    moveZ = targetZ = 0;
    moveX = camera.position.x = 0;
};
</script>
</body>
</html>
