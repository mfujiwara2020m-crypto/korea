<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Busan Flight Warp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: #fff; display: flex; justify-content: center; align-items: center; z-index: 1000; cursor: pointer; }
        .btn { padding: 15px 30px; border: 2px solid #fff; border-radius: 50px; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div id="overlay" onclick="requestPermission()">
        <div class="btn">搭乗を開始する (Tap to Fly)</div>
    </div>

<script>
let scene, camera, renderer, skyMesh, planeMesh, doorL, doorR, sphere;
let isWarping = false, warpStartTime = 0;
let hasArrived = false;
const loader = new THREE.TextureLoader();

function requestPermission() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(state => {
            if (state === 'granted') startApp();
        });
    } else { startApp(); }
}

function startApp() {
    document.getElementById('overlay').style.display = 'none';
    init();
}

function init() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.rotation.order = 'YXZ';

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // 1. 空の背景 (sora.jpg)
    loader.load('./sora.jpg', (tex) => {
        tex.wrapS = THREE.RepeatWrapping;
        skyMesh = new THREE.Mesh(new THREE.PlaneGeometry(40, 25), new THREE.MeshBasicMaterial({ map: tex }));
        skyMesh.position.z = -15;
        scene.add(skyMesh);
    });

    // 2. 飛行機の横顔 (hikouki.jpg)
    loader.load('./hikouki.jpg', (tex) => {
        planeMesh = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), new THREE.MeshBasicMaterial({ map: tex, transparent: true }));
        planeMesh.position.set(-10, 0, -8); // 画面左側に配置
        scene.add(planeMesh);
    });

    // 3. 次元の扉
    const doorGeo = new THREE.PlaneGeometry(1.5, 4);
    const doorMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
    doorL = new THREE.Mesh(doorGeo, doorMat);
    doorR = new THREE.Mesh(doorGeo, doorMat);
    doorL.position.set(-0.75, 0, -10);
    doorR.position.set(0.75, 0, -10);
    scene.add(doorL, doorR);

    // 4. 釜山の全天球 (day_2.jpg)
    loader.load('./day_2.jpg', (tex) => {
        sphere = new THREE.Mesh(
            new THREE.SphereGeometry(100, 64, 32).scale(-1, 1, 1),
            new THREE.MeshBasicMaterial({ map: tex, transparent: true, opacity: 0 })
        );
        scene.add(sphere);
    });

    window.addEventListener('deviceorientation', (e) => {
        if (hasArrived && e.alpha) {
            camera.rotation.set((e.beta - 90) * Math.PI / 180, e.alpha * Math.PI / 180, 0);
        }
    });

    window.addEventListener('touchstart', triggerWarp);
    window.addEventListener('mousedown', triggerWarp);

    animate();
}

function triggerWarp() {
    if (!isWarping && !hasArrived) {
        isWarping = true;
        warpStartTime = performance.now();
    }
}

function animate() {
    requestAnimationFrame(animate);
    const time = performance.now() * 0.001;

    if (!hasArrived) {
        // 飛行前のアイドリング（空が流れ、機体が揺れる）
        if (skyMesh) skyMesh.material.map.offset.x += 0.001;
        if (planeMesh && !isWarping) {
            planeMesh.position.y = Math.sin(time * 2) * 0.1;
            // 徐々に中央へ近づく
            planeMesh.position.x = THREE.MathUtils.lerp(planeMesh.position.x, -4, 0.01);
        }
    }

    if (isWarping) {
        const elapsed = performance.now() - warpStartTime;
        const alpha = Math.min(elapsed / 2500, 1); // 2.5秒でワープ

        // 扉が開く
        doorL.position.x = -0.75 - (alpha * 6);
        doorR.position.x = 0.75 + (alpha * 6);

        // 飛行機が扉へ向かって加速
        if (planeMesh) {
            planeMesh.position.x += 0.15; // 右へ前進
            // 扉の中心（x=0）に来たら消滅
            if (planeMesh.position.x >= 0) {
                scene.remove(planeMesh);
                planeMesh = null;
            }
        }

        // 飛行機が消えた後の景色切り替え
        if (!planeMesh) {
            if (skyMesh) skyMesh.material.opacity = Math.max(0, skyMesh.material.opacity - 0.1);
            if (sphere) sphere.material.opacity = Math.min(1, sphere.material.opacity + 0.1);
            
            // 釜山へ到着
            if (alpha > 0.8) {
                hasArrived = true;
                isWarping = false;
                scene.remove(doorL, doorR, skyMesh);
            }
        }
    }
    renderer.render(scene, camera);
}
</script>
</body>
</html>
